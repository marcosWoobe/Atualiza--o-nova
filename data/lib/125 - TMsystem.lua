-- TM System by: Uissu

tmSprites = {
["bug"] = 17207,
["dark"] = 17208,
["dragon"] = 17209,
["electric"] = 17210,
["fairy"] = 17211,
["fighting"] = 17212,
["fire"] = 17213,
["flying"] = 17214,
["ghost"] = 17215,
["grass"] = 17216,
["ground"] = 17217,
["ice"] = 17218,
["normal"] = 17219,
["poison"] = 17220,
["psychic"] = 17221,
["rock"] = 17222,
["steel"] = 17223,
["water"] = 17224,
}

tmTable = {
-------["MoveName"] = {class = "X", num = 00},

["Focus Punch"] = {class = "B", num = 01},
["Dragon Claw"] = {class = "B", num = 02},
["Water Pulse"] = {class = "A", num = 03},
["Calm Mind"] = {class = "A", num = 04},
["Roar"] = {class = "B", num = 05},
["Toxic"] = {class = "C", num = 06},
["Zap Cannon"] = {class = "B", num = 07},
["Bulk Up"] = {class = "S", num = 08},
["Bullet Seed"] = {class = "C", num = 09},
["Hidden Power"] = {class = "C", num = 10},
["Sunny Day"] = {class = "A", num = 11},
["Taunt"] = {class = "C", num = 12},
["Ice Beam"] = {class = "A", num = 13},
["Blizzard"] = {class = "A", num = 14},
["Hyper Beam"] = {class = "S", num = 15},
["Light Screen"] = {class = "S", num = 16},
["Protect"] = {class = "A", num = 17},
["Rain Dance"] = {class = "A", num = 18},
["Giga Drain"] = {class = "A", num = 19},
["Safeguard"] = {class = "A", num = 20},
--["Frustration"] = {class = "A", num = 21},
["Solar Beam"] = {class = "A", num = 22},
["Iron Tail"] = {class = "C", num = 23},
["Thunderbolt"] = {class = "A", num = 24},
["Thunder"] = {class = "S", num = 25},
["Earthquake"] = {class = "S", num = 26},
["Fissure"] = {class = "A", num = 27},
["Dig"] = {class = "A", num = 28},
["Psychic"] = {class = "B", num = 29},
["Shadow Ball"] = {class = "B", num = 30},
["Brick Break"] = {class = "A", num = 31},
["Double Team"] = {class = "S", num = 32},
["Reflect"] = {class = "A", num = 33},
["Shock Wave"] = {class = "B", num = 34},
["Flamethrower"] = {class = "B", num = 35},
["Sludge Bomb"] = {class = "A", num = 36},
["Sandstorm"] = {class = "S", num = 37},
["Fire Blast"] = {class = "A", num = 38},
["Rock Tomb"] = {class = "A", num = 39},
["Aerial Ace"] = {class = "S", num = 40},
["Thunder Punch"] = {class = "B", num = 41},
--["Facade"] = {class = "A", num = 42},
["Detect"] = {class = "S", num = 43},
--["Rest"] = {class = "A", num = 44},
--["Attract"] = {class = "A", num = 45},
["Psywave"] = {class = "C", num = 46},
["Steel Wing"] = {class = "A", num = 47},
["Fire Punch"] = {class = "A", num = 48},
["Fury Cutter"] = {class = "C", num = 49},
["Overheat"] = {class = "B", num = 50},
["Roost"] = {class = "S", num = 51},
["Focus Blast"] = {class = "A", num = 52},
--["Energy Ball"] = {class = "A", num = 53},
--["False Swipe"] = {class = "X", num = 54},
["Brine"] = {class = "C", num = 55},
--["Fling"] = {class = "X", num = 56},
["Charge Beam"] = {class = "B", num = 57},
--["Endure"] = {class = "X", num = 00},
["Dragon Pulse"] = {class = "B", num = 59},
["Drain Punch"] = {class = "S", num = 60},
--["Will-O-Wisp"] = {class = "X", num = 00},
["Silver Wind"] = {class = "C", num = 62},
--["Embargo"] = {class = "X", num = 00},
--["Explosion"] = {class = "S", num = 64},
["Shadow Claw"] = {class = "S", num = 65},
--["Payback"] = {class = "X", num = 00},
--["Recycle"] = {class = "X", num = 00},
--["Giga Impact"] = {class = "X", num = 00},
--["Rock Polish"] = {class = "X", num = 00},
--["Flash"] = {class = "X", num = 00},
["Stone Edge"] = {class = "B", num = 71},
--["Avalanche"] = {class = "X", num = 00},
["Thunder Wave"] = {class = "B", num = 73},
["Gyro Ball"] = {class = "A", num = 74},
["Swords Dance"] = {class = "S", num = 75},
["Stealth Rock"] = {class = "S", num = 76},
--["Psych Up"] = {class = "X", num = 00},
["Bulldoze"] = {class = "C", num = 78},
["Dark Pulse"] = {class = "B", num = 79},
["Rock Slide"] = {class = "B", num = 80},
["X-Scissor"] = {class = "B", num = 81},
["Dragon Tail"] = {class = "C", num = 82},
--["Natural Gift"] = {class = "X", num = 00},
["Poison Jab"] = {class = "B", num = 84},
["Dream Eater"] = {class = "B", num = 85},
--["Grass Knot"] = {class = "X", num = 00},
--["Swagger"] = {class = "X", num = 00},
["Pluck"] = {class = "C", num = 88},
["U-Turn"] = {class = "B", num = 89},
--["Substitute"] = {class = "X", num = 00},
["Flash Cannon"] = {class = "A", num = 91},
--["Trick Room"] = {class = "X", num = 00},
["Wild Charge"] = {class = "A", num = 93},
["Dazzling Gleam"] = {class = "B", num = 99},

["Bubbles"] = {class = "C", num = 101},
["Tackle"] = {class = "D", num = 102},
["Spark"] = {class = "C", num = 103},
["Hydro Cannon"] = {class = "A", num = 104},
["Shadow Punch"] = {class = "A", num = 105},
["Thunder Fang"] = {class = "S", num = 106},
["Ice Fang"] = {class = "S", num = 107},
["Fire Fang"] = {class = "S", num = 108},
["Iron Head"] = {class = "C", num = 109},
["Metal Claw"] = {class = "S", num = 110},
["Scald"] = {class = "A", num = 111},
["Bite"] = {class = "D", num = 112},
["Thunder Shock"] = {class = "D", num = 113},
["Magical Leaf"] = {class = "C", num = 114},
["Razor Leaf"] = {class = "D", num = 115},
["Rock Throw"] = {class = "D", num = 116},
["Aura Sphere"] = {class = "C", num = 117},
["Ember"] = {class = "D", num = 118},
["Fireball"] = {class = "C", num = 119},
["Earth Power"] = {class = "C", num = 120},
["Wing Attack"] = {class = "C", num = 121},
["Twister"] = {class = "D", num = 122},
["Night Slash"] = {class = "B", num = 123},
["Psy Pulse"] = {class = "D", num = 124},
["Headbutt"] = {class = "D", num = 125},
["Air Slash"] = {class = "B", num = 126},
["Sludge"] = {class = "D", num = 127},
["Sludge Bomb"] = {class = "C", num = 128},
["Ice Beam"] = {class = "A", num = 129},
["Waterball"] = {class = "C", num = 130},
["Selfdestruct"] = {class = "S", num = 131},
["Drill Peck"] = {class = "C", num = 132},
["Moonblast"] = {class = "S", num = 133},
}

tmClassById = {
[17202] = "S",
[17203] = "A",
[17204] = "B",
[17205] = "C",
[17206] = "D",
}

function getPBMoves(player)
	local ball = getPlayerSlotItem(player, 8)
	local btm = getBallTM(ball.uid)
	local pokeName = getItemAttribute(ball.uid, "poke")
	local t = movestable[pokeName]
	local ret = {}
	if t then
		for i,v in pairs(t) do
			local mid = tonumber(i:sub(5,6))
			if btm and tonumber(btm:explode("|")[2]) == mid then
				ret[mid] = mid == 1 and '[TM] '..btm:explode("|")[1] or "|[TM] ".. btm:explode("|")[1]
			else
				if not v.passive and not v.name:find("Mega -") then
					ret[mid] = mid == 1 and v.name or "|".. v.name
				end
			end
		end
	end
	return table.concat(ret)
end

-- function getMoveTypeByName(name)
	-- for i,v in pairs(tableMoves) do
		-- for ii,vv in pairs(v) do
			-- if vv.name == name then
				-- return vv.t
			-- end
		-- end
	-- end
	-- print("Move type not found for ".. name)
	-- return "normal"
-- end

function doPlayerAddRandomTM(cid, class, ForceName)
	local retr = {}
	for name, v in pairs(tmTable) do
		if v.class == class then
			table.insert(retr, name)
		end
	end
	local tmName = retr[math.random(#retr)]
	if ForceName then tmName = ForceName end
	local t = tmTable[tmName]
	local spriteid = tmSprites[tableMoves[tmName].type] or 17219 -- 17219 = normal
	if not spriteid then
		spriteid = 17219
		return true
	end
	local retitem = doCreateItemEx(spriteid)
	doSetItemAttribute(retitem, "TMName", tmName)
	
	local temp = {cdMin = 999, cdMax = 30, fMin = 999, fMax = 0}
	local cdR, cdMin, cdMax = 0, temp.cdmin, temp.cdmax
	local fR, fMin, fMax = 0, temp.fmin, temp.fmax
	
	for pokename,t in pairs(movestable) do
		for i,v in pairs(t) do
			if v.name == tmName and not isInArray({"Fire Barricade", "Evil Dusknoir", "Mewtwo", "Mew", "Celebi", "Lugia", "Ho-Oh", "Articuno", "Moltres", "Zapdos", "Suicune", "Raikou", "Entei"}, pokename) then
				if tableMoves[tmName].force > temp.fMax then temp.fMax = tableMoves[tmName].force end
				if tableMoves[tmName].force < temp.fMin then temp.fMin = tableMoves[tmName].force end
				if v.cd > temp.cdMax then temp.cdMax = v.cd end
				if v.cd < temp.cdMin then temp.cdMin = v.cd end
			end
		end
	end
	cdR = math.random(temp.cdMin, temp.cdMax)
	fR = math.random(temp.fMin, temp.fMax)
	
	doSetItemAttribute(retitem, "TMCD", cdR)
	doSetItemAttribute(retitem, "TMF", fR)
	local perfF = ((fR - temp.fMin) / (temp.fMax - temp.fMin))
	if fR == 0 then perfF = 1 end
	local perfCD = ((temp.cdMax - cdR) / (temp.cdMax - temp.cdMin))
	local perfection = math.floor(perfF * 50 + perfCD * 50)
	doSetItemAttribute(retitem, "TMPerf", perfection)
	doSendMsg(cid, "You've opened a TM Box Class ".. class .." and received a TM"..t.num.." ".. tmName ..". ".. (fR == 0 and "[" or (" [Power: ".. fR .." | ")) .."CD: ".. cdR .."]")
	
	doPlayerAddItemEx(cid, retitem)
end

function doSetBallTM(item, tmname, slot, cd, f)
	local dist, target = 1, 1
	for pokename,t in pairs(movestable) do
		for i,v in pairs(t) do
			if v.name == tmname then
				dist = v.dist
				target = v.target
				break
			end
		end
	end
	if not dist then dist = tableMoves[tmname].dist or 0 end
	if not target then target = 0 end
	doSendMagicEffect(getThingPos(item), 28)
	return doItemSetAttribute(item, "TM", tmname.."|"..slot.."|"..cd.."|"..target.."|".. dist .."|"..f) 
end

function getBallTM(item)
	return getItemAttribute(item, "TM") or false
end

function getTMTable(item)
	local t = getBallTM(item):explode("|")
	local ret = {name = t[1], level = 1, cd = t[3], dist = t[5], target = t[4], f = t[6], t = "normal"}
	return ret
end